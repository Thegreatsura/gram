-- Modify "deployments" table
ALTER TABLE "deployments" ALTER COLUMN "user_id" TYPE text, DROP COLUMN "manifest_version", DROP COLUMN "manifest_url", ADD COLUMN "idempotency_key" text NOT NULL, ADD CONSTRAINT "deployments_project_id_idempotency_key" UNIQUE ("project_id", "idempotency_key"), ADD CONSTRAINT "deployments_project_id_fkey" FOREIGN KEY ("project_id") REFERENCES "projects" ("id") ON UPDATE NO ACTION ON DELETE RESTRICT;
-- Create "deployments_openapiv3_assets" table
CREATE TABLE "deployments_openapiv3_assets" ("id" uuid NOT NULL DEFAULT generate_uuidv7(), "project_id" uuid NOT NULL, "deployment_id" uuid NOT NULL, "asset_id" uuid NOT NULL, "name" text NOT NULL, "slug" text NOT NULL, PRIMARY KEY ("id"), CONSTRAINT "deployments_openapiv3_assets_project_id_slug_key" UNIQUE ("project_id", "slug"), CONSTRAINT "deployments_openapiv3_assets_asset_id_fkey" FOREIGN KEY ("asset_id") REFERENCES "assets" ("id") ON UPDATE NO ACTION ON DELETE RESTRICT, CONSTRAINT "deployments_openapiv3_assets_deployment_id_fkey" FOREIGN KEY ("deployment_id") REFERENCES "deployments" ("id") ON UPDATE NO ACTION ON DELETE RESTRICT);
