-- Modify "deployments_openapiv3_assets" table
ALTER TABLE "deployments_openapiv3_assets" DROP CONSTRAINT "deployments_openapiv3_assets_asset_id_fkey", DROP CONSTRAINT "deployments_openapiv3_assets_deployment_id_fkey", DROP COLUMN "project_id", ADD CONSTRAINT "deployments_openapiv3_documents_asset_id_fkey" FOREIGN KEY ("asset_id") REFERENCES "assets" ("id") ON UPDATE NO ACTION ON DELETE CASCADE, ADD CONSTRAINT "deployments_openapiv3_documents_deployment_id_fkey" FOREIGN KEY ("deployment_id") REFERENCES "deployments" ("id") ON UPDATE NO ACTION ON DELETE CASCADE;
-- Create "openapiv3_documents" table
CREATE TABLE "openapiv3_documents" ("id" uuid NOT NULL DEFAULT generate_uuidv7(), "project_id" uuid NOT NULL, "deployment_id" uuid NULL, "asset_id" uuid NOT NULL, "name" text NOT NULL, "slug" text NOT NULL, "created_at" timestamptz NOT NULL DEFAULT clock_timestamp(), "updated_at" timestamptz NOT NULL DEFAULT clock_timestamp(), "deleted_at" timestamptz NULL, "deleted" boolean NOT NULL GENERATED ALWAYS AS (deleted_at IS NOT NULL) STORED, PRIMARY KEY ("id"), CONSTRAINT "openapiv3_documents_project_id_slug_key" UNIQUE ("project_id", "slug"), CONSTRAINT "openapiv3_documents_asset_id_fkey" FOREIGN KEY ("asset_id") REFERENCES "assets" ("id") ON UPDATE NO ACTION ON DELETE RESTRICT, CONSTRAINT "openapiv3_documents_deployment_id_fkey" FOREIGN KEY ("deployment_id") REFERENCES "deployments" ("id") ON UPDATE NO ACTION ON DELETE SET NULL);
-- Modify "http_tool_definitions" table
ALTER TABLE "http_tool_definitions" ADD COLUMN "openapiv3_document_id" uuid NULL, ADD CONSTRAINT "http_tool_definitions_openapiv3_document_id_fkey" FOREIGN KEY ("openapiv3_document_id") REFERENCES "openapiv3_documents" ("id") ON UPDATE NO ACTION ON DELETE RESTRICT;
